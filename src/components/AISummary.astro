---
const { content, slug } = Astro.props;
---

<div class="ai-summary-card">
  <div class="ai-title">ğŸ¤– AI æ‘˜è¦</div>
  <pre id="ai-text">æ­£åœ¨ç”Ÿæˆæ‘˜è¦â€¦</pre>
</div>

<script is:inline>
  const slug = "{slug}";
  const cacheKey = `ai-summary:${slug}`;
  const el = document.getElementById("ai-text");

  // âœ… 1. å…ˆè®€ localStorage
  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    el.textContent = cached;
  } else {
    fetch("/api/ai-summary", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        content: content.replace(/`/g, "\\`"),
        slug
      }),
    })
      .then(r => r.json())
      .then(data => {
        if (data.summary) {
          el.textContent = data.summary;
          localStorage.setItem(cacheKey, data.summary);
        } else {
          el.textContent = "æ‘˜è¦ç”Ÿæˆå¤±æ•—";
        }
      })
      .catch(() => {
        el.textContent = "æ‘˜è¦æš«æ™‚ç„¡æ³•é¡¯ç¤º";
      });
  }
</script>

<style>
.ai-summary-card {
  margin-bottom: 1.5rem;
  padding: 1rem 1.25rem;
  border-radius: 0.75rem;
  background: var(--card-bg);
  border: 1px dashed var(--line-divider);
}
.ai-title {
  font-size: 0.85rem;
  opacity: 0.7;
  margin-bottom: 0.5rem;
}
pre {
  white-space: pre-wrap;
  font-size: 0.95rem;
  line-height: 1.6;
}
</style>
