---
import { profileConfig } from "../config";
import { url } from "../utils/url-utils";

const currentYear = new Date().getFullYear();

// 在 server-side（build / SSR）取得最新 commit（若環境允許）
let latestCommit = null;

try {
  const apiUrl = "https://api.github.com/repos/kairo0916/blog/commits?per_page=1";
  const headers = {};

  if (process.env.GITHUB_TOKEN) {
    headers["Authorization"] = `token ${process.env.GITHUB_TOKEN}`;
  }

  const res = await fetch(apiUrl, { headers });
  if (res.ok) {
    const commits = await res.json();
    if (Array.isArray(commits) && commits.length > 0) {
      const c = commits[0];
      const sha = c.sha || "";
      const shortSha = sha.slice(0, 7);
      const isoDate = (c.commit && (c.commit.committer?.date || c.commit.author?.date)) || null;

      let taipei = null;
      if (isoDate) {
        const raw = new Date(isoDate).toLocaleString("zh-TW", {
          timeZone: "Asia/Taipei",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false
        });
        taipei = raw.replace(/\//g, "-").replace(/\u200E/g, "").replace(/\u202f/g, " ").trim();
      }

      latestCommit = {
        sha,
        shortSha,
        isoDate,
        taipei,
        html_url: c.html_url || `https://github.com/kairo0916/blog/commit/${sha}`
      };
    }
  } else {
    console.warn(`GitHub API returned ${res.status}`);
  }
} catch (err) {
  console.warn("Fetch latest commit failed:", err);
}
---

<!-- footer 分隔線（略小一點間距） -->
<div class="transition border-t border-black/10 dark:border-white/15 my-6 border-dashed mx-32"></div>

<!-- 外層 relative（遮罩與內容同層） -->
<div class="relative mx-6 md:mx-12 lg:mx-0">

  <!-- 主題色遮罩（在內容之下，但因為內容是半透明或有 backdrop-blur，遮罩會透出） -->
  <div
    class="absolute inset-0 rounded-2xl pointer-events-none z-0
           bg-[var(--primary)]/12 dark:bg-[var(--primary)]/16
           transition"
    aria-hidden="true"
  ></div>

  <!-- 內容層（z-10），使用半透明背景 + backdrop-blur 來讓遮罩可見但仍保證可讀性 -->
  <div
    class="relative z-10 transition rounded-2xl mb-12 flex flex-col items-center justify-center px-6 py-4
           bg-white/6 dark:bg-black/30
           backdrop-blur-sm
           text-gray-900 dark:text-gray-100
           border-dashed border-[rgba(255,255,255,0.04)] dark:border-white/10
           font-bold"
    role="contentinfo"
    aria-label="Footer"
  >
    <div class="w-full max-w-[var(--page-width)] flex flex-col items-center text-sm">
      <div class="flex flex-col items-center text-sm leading-tight space-y-0.5">

        <div class="mt-0 text-sm">&copy; 2025 - <span id="copyright-year">{currentYear}</span> {profileConfig.name}。保留所有權利。</div>

        <div class="mt-0 text-sm">
          採用
          <a
            class="link font-bold underline text-[var(--primary)]"
            target="_blank"
            rel="noopener"
            href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hant"
          >
            CC BY-NC-SA 4.0
          </a>
        </div>

        <div class="mt-0 flex items-center gap-2 text-sm">
          <a class="link font-bold text-[var(--primary)]" target="_blank" rel="noopener" href={url("rss.xml")}>RSS</a>
          <span class="opacity-40">/</span>
          <a class="link font-bold text-[var(--primary)]" target="_blank" rel="noopener" href={url("sitemap-index.xml")}>網站地圖</a>
        </div>

        <div class="mt-0 text-sm">
          本網站已
          <a class="link font-bold text-[var(--primary)]" target="_blank" rel="noopener" href="https://github.com/kairo0916/blog">開源</a>
        </div>

        <div class="mt-0 text-sm">
          由
          <a class="link font-bold text-[var(--primary)]" target="_blank" rel="noopener" href="https://astro.build">Astro</a>
          和
          <a class="link font-bold text-[var(--primary)]" target="_blank" rel="noopener" href="https://github.com/saicaca/fuwari">Fuwari</a>
          強力驅動
        </div>

        <!-- commit 簡短顯示 -->
        <div class="mt-1 text-sm">
          {latestCommit
            ? (
              <a class="no-underline text-sm font-bold" target="_blank" rel="noopener" href={latestCommit.html_url}>
                ({latestCommit.shortSha} @ {latestCommit.taipei})
              </a>
            )
            : <span class="text-sm font-bold">(無法取得最新 Commit)</span>
          }
        </div>

        <div class="mt-0 text-sm">
        由
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://www.vercel.com">Vercel</a>
        構建並部署至網路
        </div>
        <img src="../assets/image/vercel.svg" alt="Deploys by Vercel">

      </div>
    </div>
  </div>
</div>
