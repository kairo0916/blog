---
import { profileConfig } from "../config";
import { url } from "../utils/url-utils";

const currentYear = new Date().getFullYear();

// 在 server-side（build / SSR）取得最新 commit（若環境允許）
let latestCommit = null;

try {
  const apiUrl = "https://api.github.com/repos/kairo0916/blog/commits?per_page=1";
  const headers = {};

  if (process.env.GITHUB_TOKEN) {
    headers["Authorization"] = `token ${process.env.GITHUB_TOKEN}`;
  }

  const res = await fetch(apiUrl, { headers });
  if (res.ok) {
    const commits = await res.json();
    if (Array.isArray(commits) && commits.length > 0) {
      const c = commits[0];
      const sha = c.sha || "";
      const shortSha = sha.slice(0, 7);
      const isoDate = (c.commit && (c.commit.committer?.date || c.commit.author?.date)) || null;

      let taipei = null;
      if (isoDate) {
        // 使用 24 小時制，不顯示上午/下午
        const raw = new Date(isoDate).toLocaleString("zh-TW", {
          timeZone: "Asia/Taipei",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false
        });
        // 格式化為：YYYY-MM-DD HH:MM:SS
        taipei = raw.replace(/\//g, "-").replace(/\u200E/g, "").replace(/\u202f/g, " ").trim();
      }

      latestCommit = {
        sha,
        shortSha,
        isoDate,
        taipei,
        html_url: c.html_url || `https://github.com/kairo0916/blog/commit/${sha}`
      };
    }
  } else {
    console.warn(`GitHub API returned ${res.status}`);
  }
} catch (err) {
  console.warn("Fetch latest commit failed:", err);
}
---

<!-- footer 分隔線（略小一點間距） -->
<div class="transition border-t border-black/10 dark:border-white/15 my-6 border-dashed mx-32"></div>

<!-- 整個 footer 加深灰色遮罩（半透明）、所有文字粗體、行距收緊 -->
<div
  class="transition rounded-2xl mb-12 flex flex-col items-center justify-center px-6 py-4
         bg-gray-800/82 dark:bg-gray-900/82 text-gray-100
         border-dashed border-[oklch(85%_0.01_var(--hue))] dark:border-white/10
         font-bold"
  role="contentinfo"
  aria-label="Footer"
>
  <div class="w-full max-w-[var(--page-width)] flex flex-col items-center text-sm">
    <div class="flex flex-col items-center text-sm leading-tight space-y-0.5">

      <div class="mt-0">&copy; 2025 - <span id="copyright-year">{currentYear}</span> {profileConfig.name}。保留所有權利。</div>

      <div class="mt-0">
        採用
        <a
          class="link font-bold underline text-[var(--primary)]"
          target="_blank"
          rel="noopener"
          href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hant"
        >
          CC BY-NC-SA 4.0
        </a>
      </div>

      <div class="mt-0 flex items-center gap-2">
        <a class="link font-bold text-[var(--primary)]" target="_blank" rel="noopener" href={url("rss.xml")}>RSS</a>
        <span class="opacity-40">/</span>
        <a class="link font-bold text-[var(--primary)]" target="_blank" rel="noopener" href={url("sitemap-index.xml")}>網站地圖</a>
      </div>

      <div class="mt-0">
        本網站已
        <a class="link font-bold text-[var(--primary)]" target="_blank" rel="noopener" href="https://github.com/kairo0916/blog">開源</a>
      </div>

      <div class="mt-0">
        由
        <a class="link font-bold text-[var(--primary)]" target="_blank" rel="noopener" href="https://astro.build">Astro</a>
        和
        <a class="link font-bold text-[var(--primary)]" target="_blank" rel="noopener" href="https://github.com/saicaca/fuwari">Fuwari</a>
        強力驅動
      </div>

      <!-- 把 (ID @ DATE) 放到「由 ... 強力驅動」下面，簡短顯示（同樣為粗體） -->
      <div class="mt-1">
        {latestCommit
          ? (
            <a class="no-underline text-sm font-bold" target="_blank" rel="noopener" href={latestCommit.html_url}>
              ({latestCommit.shortSha} @ {latestCommit.taipei})
            </a>
          )
          : <span class="text-sm font-bold">(無法取得最新 Commit)</span>
        }
      </div>

    </div>
  </div>
</div>
