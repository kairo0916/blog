---
import type { CollectionEntry } from "astro:content";
import path from "node:path";
import { Icon } from "astro-icon/components";
import { getDir } from "../utils/url-utils";
import ImageWrapper from "./misc/ImageWrapper.astro";
import PostMetadata from "./PostMeta.astro";

interface Props {
  class?: string;
  entry: CollectionEntry<"posts">;
  title: string;
  url: string;
  published: Date;
  updated?: Date;
  image: string;
  description: string;
  style?: string;
  pinned?: boolean;
}

const {
  entry,
  title,
  url,
  published,
  updated,
  image,
  description,
  style,
} = Astro.props;

const className = Astro.props.class as string || "";
const hasCover = !!image;
const { remarkPluginFrontmatter } = await entry.render();
---
<div class:list={["card-base relative w-full rounded-[var(--radius-large)] overflow-hidden p-6 md:p-7", className]} style={style}>
  <!-- 上半部：標題 + 圖（圖片靠底部、拉長高度） -->
  <div class="flex gap-4 items-start">
    <!-- 左：文字區（占剩餘空間） -->
    <div class="flex-1 min-w-0">
      <a href={url} class="group block text-3xl font-bold text-90 mb-3 hover:text-[var(--primary)] transition">
        {title}
        <Icon name="material-symbols:chevron-right-rounded" class="inline text-[2rem] ml-1 translate-y-0.5 opacity-0 group-hover:opacity-100 transition" />
      </a>

      <!-- 描述 -->
      <div class="text-75 line-clamp-2">
        {description || remarkPluginFrontmatter.excerpt}
      </div>
    </div>

    <!-- 右：封面圖（高度拉長、靠底部） -->
    {hasCover && (
      <a href={url} aria-label={title} class="relative w-[28%] shrink-0 self-end rounded-xl overflow-hidden group active:scale-95 transition">
        <div class="absolute inset-0 z-10 bg-black/0 group-hover:bg-black/30 transition" />
        <div class="absolute inset-0 z-20 flex items-center justify-center">
          <Icon name="material-symbols:chevron-right-rounded" class="text-white text-5xl opacity-0 scale-75 group-hover:opacity-100 group-hover:scale-100 transition" />
        </div>
        <!-- 改用較高的長寬比（往下拉長的感覺）-->
        <div class="w-full h-[220px] md:h-[260px] lg:h-[300px]">
          <ImageWrapper
            src={image}
            basePath={path.join("content/posts/", getDir(entry.id))}
            alt="Cover Image"
            class="w-full h-full object-cover"
          />
        </div>
      </a>
    )}

    <!-- 若無封面，顯示右側進入按鈕（垂直置中） -->
    {!hasCover && (
      <a href={url} aria-label={title} class="!flex btn-regular w-[3.25rem] h-[3.25rem] absolute right-3 top-3 bottom-3 rounded-xl bg-[var(--enter-btn-bg)] hover:bg-[var(--enter-btn-bg-hover)] active:bg-[var(--enter-btn-bg-active)] active:scale-95">
        <Icon name="material-symbols:chevron-right-rounded" class="text-[var(--primary)] text-4xl mx-auto" />
      </a>
    )}
  </div>

  <!-- 下半部：metadata（時間、字數、分鐘） -->
  <div class="mt-4 flex items-center justify-between">
    <PostMetadata
      published={published}
      updated={updated}
      words={remarkPluginFrontmatter.words}
      minutes={remarkPluginFrontmatter.minutes}
      slug={entry.slug}
    />

    {hasCover && (
      <a href={url} aria-label={title} class="btn-regular w-[3.25rem] h-[3.25rem] rounded-xl flex items-center justify-center bg-[var(--enter-btn-bg)] hover:bg-[var(--enter-btn-bg-hover)] active:bg-[var(--enter-btn-bg-active)] active:scale-95 transition">
        <Icon name="material-symbols:chevron-right-rounded" class="text-[var(--primary)] text-4xl" />
      </a>
    )}
  </div>
</div>

<div class="transition border-t-[1px] border-dashed mx-6 border-black/10 dark:border-white/[0.15] last:border-t-0 md:hidden"></div>

<script>
  // 保留原本的 pageviews 動畫函式（若未使用 umami 也不會影響）
  function animateValue(obj, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      obj.innerHTML = Math.floor(progress * (end - start) + start);
      if (progress < 1) {
        window.requestAnimationFrame(step);
      } else {
        obj.innerHTML = end;
      }
    };
    window.requestAnimationFrame(step);
  }

  async function loadCardStats() {
    const elements = document.querySelectorAll('.post-pageviews');
    elements.forEach(async (el) => {
      if (el.classList.contains('processed') && el.textContent !== '0') return;
      el.classList.add('processed');
      const url = el.dataset.url;
      const baseUrl = el.dataset.umamiBaseUrl;
      const shareId = el.dataset.umamiShareId;
      const timezone = el.dataset.umamiTimezone;
      if (!baseUrl || !shareId) return;
      try {
        if (typeof window.fetchUmamiStats !== 'function') return;
        const statsData = await window.fetchUmamiStats(baseUrl, shareId, { url, timezone });
        const pageviews = (statsData.pageviews && statsData.pageviews.value) || statsData.pageviews || 0;
        if (statsData._fromCache) {
          el.innerHTML = pageviews;
          return;
        }
        const startVal = parseInt(el.textContent) || 0;
        if (startVal !== pageviews) {
          if (startVal === 0) {
            animateValue(el, startVal, pageviews, 1000);
          } else {
            el.innerHTML = pageviews;
          }
        }
      } catch (e) {
        console.error('Failed to load stats for', url, e);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', loadCardStats);
  document.addEventListener('swup:contentReplaced', loadCardStats);
</script>
