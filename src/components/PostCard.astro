---
import path from "node:path";
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";

import { umamiConfig } from "../config";
import { formatDateToYYYYMMDD } from "../utils/date-utils";
import { getDir } from "../utils/url-utils";
import PostMetadata from "./PostMeta.astro";
import ImageWrapper from "./misc/ImageWrapper.astro";

interface Props {
	class?: string;
	entry: CollectionEntry<"posts">;
	title: string;
	url: string;
	published: Date;
	updated?: Date;
	image: string;
	description: string;
	draft: boolean;
	style: string;
}
const { entry, title, url, published, updated, image, description, style } =
	Astro.props;

const isPinned = entry.data.pinned === true;
const className = Astro.props.class;

const hasCover = image !== undefined && image !== null && image !== "";

const coverWidth = "28%";

const { remarkPluginFrontmatter } = await entry.render();
---
<div class:list={["card-base card-hover flex flex-col w-full relative", className]} style={style}>
    <div class:list={["pl-9 pr-2 pt-6 pb-6 relative", {"w-[calc(100%_-_52px_-_12px)]": !hasCover, "w-[calc(100%_-_var(--coverWidth)_-_12px)]": hasCover}]}>
        <a href={url}
           class="transition group w-full block font-bold mb-2 md:mb-3 text-xl md:text-3xl text-90 relative
        hover:text-[var(--primary)] dark:hover:text-[var(--primary)]
        active:text-[var(--title-active)] dark:active:text-[var(--title-active)]
        before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
        before:absolute before:top-1 md:before:top-2 before:-left-[1.125rem] before:block
        ">

            {title}
            <Icon class="inline text-[2rem] text-[var(--primary)] md:hidden translate-y-0.5 absolute" name="material-symbols:chevron-right-rounded"></icon>
            <Icon class="text-[var(--primary)] text-[2rem] transition inline absolute translate-y-0.5 opacity-0 group-hover:opacity-100 -translate-x-1 group-hover:translate-x-0" name="material-symbols:chevron-right-rounded"></Icon>
        </a>

        <!-- 第一行：時間 + 觀看人數（抓同裝置） + 觀看數（不抓同裝置） -->
        <div class="mb-3 text-sm text-black/50 dark:text-white/50 flex items-center gap-3">
            <div>{formatDateToYYYYMMDD(published)}</div>
            <div>|</div>

            <!-- 觀看人數（抓同裝置） -->
            <div class="flex items-center gap-2">
                <div class="text-75">觀看人數（抓同裝置）</div>
                <div
                    class="post-unique font-medium text-90"
                    data-url={url}
                    data-umami-base-url={umamiConfig?.baseUrl || ""}
                    data-umami-share-id={umamiConfig?.shareId || ""}
                    data-umami-timezone={umamiConfig?.timezone || ""}
                >
                    0
                </div>
            </div>

            <div>|</div>

            <!-- 觀看數（不抓同裝置） -->
            <div class="flex items-center gap-2">
                <div class="text-75">觀看數（不抓同裝置）</div>
                <div
                    class="post-pageviews font-medium text-90"
                    data-url={url}
                    data-umami-base-url={umamiConfig?.baseUrl || ""}
                    data-umami-share-id={umamiConfig?.shareId || ""}
                    data-umami-timezone={umamiConfig?.timezone || ""}
                >
                    0
                </div>
            </div>
        </div>

        <!-- description -->
        <div class:list={["transition text-75 mb-3.5 pr-4 line-clamp-1 md:line-clamp-2"]}>
            { description || remarkPluginFrontmatter.excerpt }
        </div>

        <!-- 最下面只保留字數與分鐘（不再重複時間） -->
        <div class="text-sm text-black/30 dark:text-white/30 flex gap-4 transition">
            <div>{remarkPluginFrontmatter.words} 字</div>
            <div>|</div>
            <div>{remarkPluginFrontmatter.minutes} 分钟</div>
        </div>

    </div>

    {hasCover && <a href={url} aria-label={title}
                    class:list={["group",
                        "max-h-none mx-0 mt-0",
                        "w-[var(--coverWidth)] absolute top-3 bottom-3 right-3 rounded-xl overflow-hidden active:scale-95"
                    ]} >
        <div class="absolute pointer-events-none z-10 w-full h-full group-hover:bg-black/30 group-active:bg-black/50 transition"></div>
        <!-- 封面图上的箭头 -->
        <div class="absolute pointer-events-none z-20 w-full h-full flex items-center justify-center ">
            <Icon name="material-symbols:chevron-right-rounded"
                  class="transition opacity-0 group-hover:opacity-100 scale-50 group-hover:scale-100 text-white text-5xl">
            </Icon>
        </div>
        <ImageWrapper src={image} basePath={path.join("content/posts/", getDir(entry.id))} alt="Cover Image of the Post"
                  class="w-full h-full">
        </ImageWrapper>
    </a>}

    {!hasCover &&
        <a href={url} aria-label={title} class="!flex btn-regular w-[3.25rem]
         absolute right-3 top-3 bottom-3 rounded-xl bg-[var(--enter-btn-bg)]
         hover:bg-[var(--enter-btn-bg-hover)] active:bg-[var(--enter-btn-bg-active)] active:scale-95
        ">
            <Icon name="material-symbols:chevron-right-rounded"
                  class="transition text-[var(--primary)] text-4xl mx-auto">
            </Icon>
        </a>
    }
</div>
<div class="transition border-t-[1px] border-dashed mx-6 border-black/10 dark:border-white/[0.15] last:border-t-0 hidden"></div>

<style define:vars={{coverWidth}}>
</style>

<script>
    // 數字動畫（起始、結束、持續時間 ms）
    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end;
            }
        };
        window.requestAnimationFrame(step);
    }

    // 對同一 url 做一次 fetch，然後把結果填到所有同 url 的元素（包含 unique 和 pageviews）
    async function loadCardStats() {
        // 蒐集所有需要更新的元素
        const uniqueEls = Array.from(document.querySelectorAll('.post-unique'));
        const pageviewEls = Array.from(document.querySelectorAll('.post-pageviews'));

        // 合併元素，按照 key 分組（以 url + baseUrl + shareId + timezone 為 key）
        const allEls = [...uniqueEls, ...pageviewEls];
        const groups = new Map();

        allEls.forEach(el => {
            const url = el.dataset.url || '';
            const baseUrl = el.dataset.umamiBaseUrl || '';
            const shareId = el.dataset.umamiShareId || '';
            const timezone = el.dataset.umamiTimezone || '';
            const key = `${baseUrl}||${shareId}||${timezone}||${url}`;
            if (!groups.has(key)) groups.set(key, { url, baseUrl, shareId, timezone, els: [] });
            groups.get(key).els.push(el);
        });

        // 如果沒有任何元素就跳過
        if (groups.size === 0) return;

        for (const [key, group] of groups.entries()) {
            const { url, baseUrl, shareId, timezone, els } = group;

            // 標記已處理（避免重複 animate），但仍允許更新為新值
            const processedFlag = 'processed';

            // 如果 fetch 函式不存在（你在其他地方注入），就跳過
            if (typeof window.fetchUmamiStats !== 'function') {
                // 嘗試讀取 stored value（若有）或者保留原樣
                els.forEach(el => {
                    // 若元素內為 0，保留 0；否則維持原值
                });
                continue;
            }

            try {
                // window.fetchUmamiStats(baseUrl, shareId, { url, timezone })
                // 期望結果可能包含 pageviews、visitors、_fromCache 等欄位
                const statsData = await window.fetchUmamiStats(baseUrl, shareId, {
                    url: url,
                    timezone: timezone
                });

                // 嘗試解析可能的欄位（兼容不同版本的 API）
                const pageviews = (statsData && (statsData.pageviews && (statsData.pageviews.value ?? statsData.pageviews)) ) 
                                    || statsData.pageviews
                                    || 0;

                const uniqueVisitors = statsData && (statsData.visitors ?? statsData.uniques ?? statsData.unique ?? statsData.visitors_count) 
                                        || 0;

                const fromCache = statsData && statsData._fromCache;

                // 更新群組內的元素
                els.forEach(el => {
                    const isUniqueEl = el.classList.contains('post-unique');
                    const targetVal = isUniqueEl ? uniqueVisitors : pageviews;

                    const currentText = el.textContent ? el.textContent.trim() : '';
                    const startVal = parseInt(currentText.replace(/[^\d]/g, '')) || 0;

                    // 若為 cache 的結果，直接展示（不做動畫），但仍標記 processed
                    if (fromCache) {
                        el.innerHTML = targetVal;
                        el.classList.add(processedFlag);
                        return;
                    }

                    // 若數值不同且起始為 0，使用動畫；否則直接替換為最終值
                    if (startVal !== targetVal) {
                        if (startVal === 0) {
                            animateValue(el, startVal, targetVal, 1000);
                        } else {
                            el.innerHTML = targetVal;
                        }
                    }
                    el.classList.add(processedFlag);
                });

            } catch (e) {
                console.error('Failed to load stats for', url, e);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', loadCardStats);
    document.addEventListener('swup:contentReplaced', loadCardStats);
</script>
