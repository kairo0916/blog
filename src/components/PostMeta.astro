---
import { Icon } from "astro-icon/components";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import { formatDateToYYYYMMDD } from "../utils/date-utils";

interface Props {
  class?: string;
  published: Date;
  updated?: Date;
  words?: number;
  minutes?: number;
  hideUpdateDate?: boolean;
  slug?: string;
}
const {
  published,
  updated,
  words,
  minutes,
  hideUpdateDate = false,
  slug,
} = Astro.props;
const className = Astro.props.class;
---
<div class:list={["flex flex-wrap text-neutral-500 dark:text-neutral-400 items-center gap-4 gap-x-4 gap-y-2", className]}>
    <!-- publish date -->
    <div class="flex items-center">
        <div class="meta-icon">
            <Icon name="material-symbols:calendar-today-outline-rounded" class="text-xl" />
        </div>
        <span class="text-50 text-sm font-medium">{formatDateToYYYYMMDD(published)}</span>
    </div>

    <!-- update date -->
    {!hideUpdateDate && updated && updated.getTime() !== published.getTime() && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:edit-calendar-outline-rounded" class="text-xl" />
            </div>
            <span class="text-50 text-sm font-medium">{formatDateToYYYYMMDD(updated)}</span>
        </div>
    )}

    <!-- words -->
    {typeof words === "number" && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:description-outline" class="text-xl" />
            </div>
            <span class="text-50 text-sm font-medium">
                {words} {" " + i18n(words === 1 ? I18nKey.wordCount : I18nKey.wordsCount)}
            </span>
        </div>
    )}

    <!-- minutes -->
    {typeof minutes === "number" && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:schedule-outline" class="text-xl" />
            </div>
            <span class="text-50 text-sm font-medium">
                {minutes} {" " + i18n(minutes === 1 ? I18nKey.minuteCount : I18nKey.minutesCount)}
            </span>
        </div>
    )}
</div>

<!-- page views & visitors -->
    {slug && (
        <>
            <div class="flex items-center">
                <div class="meta-icon">
                    <Icon name="material-symbols:visibility-outline-rounded" class="text-xl"></Icon>
                </div>
                <span class="text-50 text-sm font-medium" id={`page-views-${slug}`}>-</span>
            </div>
            <div class="flex items-center">
                <div class="meta-icon">
                    <Icon name="material-symbols:person" class="text-xl"></Icon>
                </div>
                <span class="text-50 text-sm font-medium" id={`page-visitors-${slug}`}>-</span>
            </div>
        </>
    )}
</div>

{slug && (
    <script define:vars={{ slug, umamiConfig }}>
        
     
        async function fetchPageViews() {
            if (!umamiConfig.enable) return;
            try {
                const statsData = await fetchUmamiStats(umamiConfig.baseUrl, umamiConfig.shareId, {
                    timezone: umamiConfig.timezone,
                    path: `eq./posts/${slug}/`
                });
                
                const pageViews = statsData.pageviews || 0;
                const visits = statsData.visitors || 0;
                
                const viewsElement = document.getElementById(`page-views-${slug}`);
                const visitorsElement = document.getElementById(`page-visitors-${slug}`);
                if (viewsElement) viewsElement.textContent = pageViews;
                if (visitorsElement) visitorsElement.textContent = visits;
            } catch (error) {
                console.error('Error fetching page views:', error);
                const viewsElement = document.getElementById(`page-views-${slug}`);
                const visitorsElement = document.getElementById(`page-visitors-${slug}`);
                if (viewsElement) viewsElement.textContent = '-';
                if (visitorsElement) visitorsElement.textContent = '-';
            }
        }

       
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fetchPageViews);
        } else {
            fetchPageViews();
        }
    </script>
)}