---
import { Icon } from "astro-icon/components";
import { profileConfig, umamiConfig } from "../../config";
import ImageWrapper from "../misc/ImageWrapper.astro";

const config = profileConfig;
---

<div class="card-base p-3">
  <a aria-label="Avatar - Kairo Blog" href="#" class="group block relative mx-auto mt-1 mb-3 max-w-[12rem] overflow-hidden rounded-xl active:scale-95">
    <div class="absolute inset-0 pointer-events-none transition group-hover:bg-black/30 group-active:bg-black/50 z-10 flex items-center justify-center">
      <Icon name="fa6-regular:address-card" class="text-white text-5xl transition opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100" />
    </div>

    <ImageWrapper src={config.avatar || ""} alt="Profile Image" class="mx-auto w-full h-full" />
  </a>

  <div class="px-2">
    <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50">{config.name}</div>
    <div class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2"></div>
    <div class="text-center text-neutral-400 mb-2.5">{config.bio}</div>

    <div class="flex flex-wrap gap-2 justify-center mb-1">
      {config.links && config.links.length > 1 &&
        config.links.map(function (item) {
          return (
            <a rel="me" aria-label={item.name} href={item.url} target="_blank" class="btn-regular rounded-lg h-10 w-10 active:scale-90">
              <Icon name={item.icon} class="text-[1.5rem]" />
            </a>
          );
        })
      }

      {config.links && config.links.length === 1 && (
        <a rel="me" aria-label={config.links[0].name} href={config.links[0].url} target="_blank" class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95">
          <Icon name={config.links[0].icon} class="text-[1.5rem]" />
          {config.links[0].name}
        </a>
      )}
    </div>

    <div class="grid grid-cols-2 mt-3 pt-3 border-t border-neutral-200 dark:border-neutral-700">
      <div class="text-center">
        <div class="text-xs text-neutral-500 mb-1 flex items-center justify-center gap-1">
          <Icon name="material-symbols:visibility-outline" class="text-base" />
          <span>訪問量</span>
        </div>
        <div id="site-views" class="font-bold text-lg text-neutral-700 dark:text-neutral-300">載入中…</div>
      </div>

      <div class="text-center border-l border-neutral-200 dark:border-neutral-700">
        <div class="text-xs text-neutral-500 mb-1 flex items-center justify-center gap-1">
          <Icon name="material-symbols:person" class="text-base" />
          <span>訪客數</span>
        </div>
        <div id="site-visitors" class="font-bold text-lg text-neutral-700 dark:text-neutral-300">載入中…</div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ umamiConfig }}>
(function () {
  // ------- utils -------
  function safeNumber(v) {
    if (v === null || v === undefined) return null;
    if (typeof v === "number") return v;
    if (typeof v === "string") {
      var s = v.replace(/[, ]+/g, "");
      var n = Number(s);
      return Number.isFinite(n) ? n : null;
    }
    if (typeof v === "object" && "value" in v) {
      return safeNumber(v.value);
    }
    return null;
  }

  function parseShareResponse(data) {
    // support proxy wrapper: { ok, status, url, data }
    if (data && typeof data === "object" && ("data" in data)) {
      data = data.data;
    }
    if (!data) return { pageviews: 0, visitors: 0 };

    // Preferred Share API shape: { pageviews: 123, visitors: 45 }
    var pv = safeNumber(data.pageviews);
    var uv = safeNumber(data.visitors);
    if (pv !== null || uv !== null) {
      return { pageviews: pv || 0, visitors: uv || 0 };
    }

    // If data is array (time series), sum up
    if (Array.isArray(data)) {
      var sumPv = 0;
      var sumUv = 0;
      for (var i = 0; i < data.length; i++) {
        var item = data[i] || {};
        sumPv += Number(safeNumber(item.pageviews) || safeNumber(item.views) || 0);
        sumUv += Number(safeNumber(item.visitors) || 0);
      }
      return { pageviews: sumPv, visitors: sumUv };
    }

    // fallback: try common nested locations
    if (data.pageviews && typeof data.pageviews === "object") {
      pv = safeNumber(data.pageviews.value || data.pageviews.total || data.pageviews.count);
    }
    if (data.visitors && typeof data.visitors === "object") {
      uv = safeNumber(data.visitors.value || data.visitors.total || data.visitors.count);
    }
    return { pageviews: pv || 0, visitors: uv || 0 };
  }

  // ------- DOM helpers -------
  function setStatsToDOM(pv, uv) {
    var viewsEl = document.getElementById("site-views");
    var visitorsEl = document.getElementById("site-visitors");
    if (!viewsEl || !visitorsEl) return;
    // set text and a dataset flag with timestamp so we can detect overwrites
    var ts = String(Date.now());
    viewsEl.textContent = String(Number(pv || 0)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    visitorsEl.textContent = String(Number(uv || 0)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    viewsEl.setAttribute("data-umami-updated", ts);
    visitorsEl.setAttribute("data-umami-updated", ts);
    console.info("[Umami] wrote stats to DOM:", { pageviews: pv, visitors: uv, ts: ts });
  }

  // If something else overwrites our nodes, this observer will detect and log + attempt restore
  function attachOverwriteObserver() {
    var viewsEl = document.getElementById("site-views");
    var visitorsEl = document.getElementById("site-visitors");
    if (!viewsEl || !visitorsEl) return;

    function makeObserver(el, name) {
      var lastValue = el.textContent;
      var observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (m) {
          var nowVal = el.textContent;
          var updatedTs = el.getAttribute("data-umami-updated");
          // if updatedTs missing or changed to older, note it
          if (nowVal !== lastValue) {
            console.warn("[Umami] Detected DOM change on", name, "newValue:", nowVal, "previous:", lastValue, "data-umami-updated:", updatedTs);
            // if our last write had a timestamp, reapply it (best-effort)
            if (updatedTs) {
              // reapply lastValue (restore)
              console.info("[Umami] attempting to restore previous value for", name);
              el.textContent = lastValue;
            } else {
              // record the new lastValue
              lastValue = nowVal;
            }
          }
        });
      });
      observer.observe(el, { childList: true, characterData: true, subtree: true });
      return observer;
    }

    makeObserver(viewsEl, "site-views");
    makeObserver(visitorsEl, "site-visitors");
  }

  // ------- fetch strategies -------
  function tryDirectShareFetch(baseUrl, shareId, cb) {
    try {
      var base = String(baseUrl || "");
      while (base.endsWith("/")) base = base.slice(0, -1);
      var url = base + "/share/" + String(shareId) + "/stats";
      console.info("[Umami] trying share API direct fetch:", url);
      fetch(url, { method: "GET", credentials: "omit" })
        .then(function (res) {
          console.info("[Umami] direct fetch status", res.status);
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(function (json) {
          console.info("[Umami] direct fetch body:", json);
          cb(null, json);
        })
        .catch(function (err) {
          cb(err);
        });
    } catch (e) {
      cb(e);
    }
  }

  function tryProxyFetch(proxyPath, baseUrl, shareId, cb) {
    try {
      var params = "baseUrl=" + encodeURIComponent(String(baseUrl || "")) + "&websiteId=" + encodeURIComponent(String(shareId || ""));
      var proxyUrl = proxyPath + "?" + params;
      console.info("[Umami] trying proxy fetch:", proxyUrl);
      fetch(proxyUrl, { method: "GET", credentials: "same-origin" })
        .then(function (res) {
          console.info("[Umami] proxy fetch status", res.status);
          if (!res.ok) throw new Error("Proxy HTTP " + res.status);
          return res.json();
        })
        .then(function (json) {
          console.info("[Umami] proxy fetch body:", json);
          cb(null, json);
        })
        .catch(function (err) {
          cb(err);
        });
    } catch (e) {
      cb(e);
    }
  }

  // ------- main -------
  function load() {
    var viewsEl = document.getElementById("site-views");
    var visitorsEl = document.getElementById("site-visitors");
    if (!viewsEl || !visitorsEl) return;

    if (!umamiConfig || !umamiConfig.enable) {
      console.info("[Umami] disabled in config");
      viewsEl.textContent = "-";
      visitorsEl.textContent = "-";
      return;
    }

    var baseUrl = umamiConfig.baseUrl || "";
    var shareId = umamiConfig.shareId || umamiConfig.websiteId || umamiConfig.siteId || "";

    if (!baseUrl || !shareId) {
      console.warn("[Umami] missing baseUrl or shareId in umamiConfig", umamiConfig);
      viewsEl.textContent = "-";
      visitorsEl.textContent = "-";
      return;
    }

    // attach observer so we can detect overwrites
    attachOverwriteObserver();

    // step 1: try direct share fetch
    tryDirectShareFetch(baseUrl, shareId, function (err, body) {
      if (!err && body) {
        var parsed = parseShareResponse(body);
        setStatsToDOM(parsed.pageviews, parsed.visitors);
        return;
      }
      console.warn("[Umami] direct fetch failed:", err);

      // step 2: try proxy if available
      // only attempt proxy path at /api/umami-proxy
      tryProxyFetch("/api/umami-proxy", baseUrl, shareId, function (err2, body2) {
        if (!err2 && body2) {
          var parsed2 = parseShareResponse(body2);
          setStatsToDOM(parsed2.pageviews, parsed2.visitors);
          return;
        }
        console.error("[Umami] proxy fetch failed:", err2);

        // final fallback: set '-' and leave logs
        viewsEl.textContent = "-";
        visitorsEl.textContent = "-";
      });
    });

    // extra: retry every 60s to ensure eventual success and counter temporary overwrites
    setInterval(function () {
      tryDirectShareFetch(baseUrl, shareId, function (e, b) {
        if (!e && b) {
          var p = parseShareResponse(b);
          setStatsToDOM(p.pageviews, p.visitors);
        }
      });
    }, 60000);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", load);
  } else {
    load();
  }
})();
</script>
