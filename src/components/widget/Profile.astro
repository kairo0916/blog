---
import { Icon } from "astro-icon/components";
import { profileConfig } from "../../config";
import ImageWrapper from "../misc/ImageWrapper.astro";

const config = profileConfig || {};
const initialOneLiner = config.oneLiner || config.tagline || config['一句話'] || "";
---
<div class="card-base p-3">
  <!-- 頭像 -->
  <a
    aria-label="Avatar - Kairo Blog"
    href="#"
    class="group block relative mx-auto mt-1 mb-3 max-w-[12rem] h-[12rem] overflow-hidden rounded-xl active:scale-95"
  >
    <div class="absolute inset-0 pointer-events-none transition group-hover:bg-black/30 group-active:bg-black/50 z-10 flex items-center justify-center">
      <Icon name="fa6-regular:address-card" class="text-white text-5xl transition opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100" />
    </div>

    <ImageWrapper src={config.avatar || ""} alt="Profile Image" class="mx-auto w-full h-full object-cover" />
  </a>

  <!-- 名稱 -->
  <div class="px-2">
    <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50">{config.name}</div>
    <div class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2"></div>

    <!-- 描述 -->
    <div class="text-center text-neutral-400 mb-2.5">
      {config.bio}
    </div>

    <!-- 按鈕（保持原樣） -->
    <div class="flex flex-wrap gap-2 justify-center mb-3">
      {config.links && config.links.length > 1 &&
        config.links.map(function (item) {
          return (
            <a rel="me" aria-label={item.name} href={item.url} target="_blank" class="btn-regular rounded-lg h-10 w-10 active:scale-90">
              <Icon name={item.icon} class="text-[1.5rem]" />
            </a>
          );
        })
      }

      {config.links && config.links.length === 1 && (
        <a rel="me" aria-label={config.links[0].name} href={config.links[0].url} target="_blank" class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95">
          <Icon name={config.links[0].icon} class="text-[1.5rem]" />
          {config.links[0].name}
        </a>
      )}
    </div>

    <!-- 內部淺淺分隔線（不把卡片分開） + 一言（API 載入）-->
    <div class="pt-2">
      <div class="mx-4 border-t border-neutral-200/30 dark:border-neutral-700/30"></div>

      <div class="mt-2 text-center text-sm text-neutral-500 dark:text-neutral-400 italic px-3">
        <!-- 顯示容器：先用 server-side fallback（若有） -->
        <div id="poem_container" class="flex flex-col items-center gap-1">
          <div id="poem_sentence" class="whitespace-pre-wrap leading-tight">{initialOneLiner}</div>
          <div id="poem_info" class="text-xs text-neutral-400"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 引入今日詩詞 SDK（不要 defer，照官方方式載入） -->
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>

<script type="text/javascript">
  (function () {
    const sentenceEl = document.getElementById('poem_sentence');
    const infoEl = document.getElementById('poem_info');

    // 根據字數調整字級
    function adjustFontSizeByLength(el) {
      if (!el) return;
      const text = (el.textContent || '').trim();
      const len = Array.from(text).length;

      let fontSize = 18;
      if (len <= 20) fontSize = 18;
      else if (len <= 40) fontSize = 16;
      else if (len <= 60) fontSize = 14;
      else if (len <= 100) fontSize = 13;
      else fontSize = 12;

      el.style.fontSize = fontSize + 'px';
      el.style.lineHeight = '1.25';
      el.style.maxWidth = '100%';
    }

    // 嘗試載入 jinrishici（有重試機制）
    function tryLoadJinrishici(attemptsLeft = 20) {
      if (typeof jinrishici !== 'undefined' && typeof jinrishici.load === 'function') {
        try {
          jinrishici.load(function (result) {
            try {
              if (!result || !result.data) {
                // 若 API 回來沒資料，保持 fallback 與字級
                adjustFontSizeByLength(sentenceEl);
                return;
              }

              const content = (result.data.content || '').trim();
              const origin = result.data.origin || {};
              const dynasty = origin.dynasty || '';
              const author = origin.author || '';
              const title = origin.title || '';

              if (sentenceEl) {
                sentenceEl.textContent = content || sentenceEl.textContent || '';
                adjustFontSizeByLength(sentenceEl);
              }

              if (infoEl) {
                const parts = [];
                if (dynasty) parts.push('【' + dynasty + '】');
                if (author) parts.push(author);
                if (title) parts.push('《' + title + '》');
                infoEl.textContent = parts.join(' ');
              }
            } catch (err) {
              console.error('jinrishici callback error:', err);
              adjustFontSizeByLength(sentenceEl);
            }
          });
        } catch (e) {
          console.error('jinrishici.load error:', e);
          adjustFontSizeByLength(sentenceEl);
        }
      } else {
        if (attemptsLeft > 0) {
          setTimeout(function () { tryLoadJinrishici(attemptsLeft - 1); }, 50);
        } else {
          // 最後還是沒載到，保持 fallback 字級
          adjustFontSizeByLength(sentenceEl);
        }
      }
    }

    // 開始嘗試（在 DOMReady 時）
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(() => tryLoadJinrishici(20), 0);
    } else {
      document.addEventListener('DOMContentLoaded', function () {
        tryLoadJinrishici(20);
      });
    }
  })();
</script>
