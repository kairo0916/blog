---
import { Icon } from "astro-icon/components";
import { profileConfig, umamiConfig } from "../../config";
import { url } from "../../utils/url-utils";
import ImageWrapper from "../misc/ImageWrapper.astro";

const config = profileConfig;
const BLOG_NAME = "Kairo Blog";
---

<div class="card-base p-3">
  <a
    aria-label={`Avatar - ${BLOG_NAME}`}
    href={url("#")}
    class="group block relative mx-auto mt-1 mb-3
           max-w-[12rem] overflow-hidden rounded-xl active:scale-95"
  >
    <div
      class="absolute transition pointer-events-none
             group-hover:bg-black/30 group-active:bg-black/50
             w-full h-full z-50 flex items-center justify-center"
    >
      <Icon
        name="fa6-regular:address-card"
        class="transition opacity-0 scale-90
               group-hover:scale-100 group-hover:opacity-100
               text-white text-5xl"
      />
    </div>

    <ImageWrapper
      src={config.avatar || ""}
      alt="Profile Image"
      class="mx-auto w-full h-full"
    />
  </a>

  <div class="px-2">
    <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50">
      {config.name}
    </div>

    <div class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2"></div>

    <div class="text-center text-neutral-400 mb-2.5">
      {config.bio}
    </div>

    <div class="grid grid-cols-2 mt-3 pt-3 border-t border-neutral-200 dark:border-neutral-700">
      <div class="text-center">
        <div class="text-xs text-neutral-500 mb-1 flex items-center justify-center gap-1">
          <Icon name="material-symbols:visibility-outline" class="text-base" />
          <span>訪問量</span>
        </div>
        <div
          id="site-views"
          class="font-bold text-lg text-neutral-700 dark:text-neutral-300"
        >
          -
        </div>
      </div>

      <div class="text-center border-l border-neutral-200 dark:border-neutral-700">
        <div class="text-xs text-neutral-500 mb-1 flex items-center justify-center gap-1">
          <Icon name="material-symbols:person" class="text-base" />
          <span>訪客數</span>
        </div>
        <div
          id="site-visitors"
          class="font-bold text-lg text-neutral-700 dark:text-neutral-300"
        >
          -
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Umami site stats -->
<script define:vars={{ umamiConfig }} type="module">
  async function loadSiteStats() {
    if (!umamiConfig || !umamiConfig.enable) return;

    const viewsEl = document.getElementById("site-views");
    const visitorsEl = document.getElementById("site-visitors");

    try {
      const baseUrl = umamiConfig.baseUrl.replace(/\/$/, "");
      const websiteId = umamiConfig.shareId;

      const api =
        `${baseUrl}/api/website/${websiteId}/stats` +
        `?metrics=pageviews,visitors&period=30d` +
        (umamiConfig.timezone
          ? `&timezone=${umamiConfig.timezone}`
          : "");

      const res = await fetch(api);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();

      const pageviews = data?.pageviews?.value ?? 0;
      const visitors = data?.visitors?.value ?? 0;

      viewsEl.textContent = pageviews;
      visitorsEl.textContent = visitors;
    } catch (err) {
      console.error("[Umami] Failed to load stats:", err);
      viewsEl.textContent = "-";
      visitorsEl.textContent = "-";
    }
  }

  document.addEventListener("DOMContentLoaded", loadSiteStats);
</script>
