---
import { Icon } from "astro-icon/components";
import { profileConfig, umamiConfig } from "../../config";
import { url } from "../../utils/url-utils";
import ImageWrapper from "../misc/ImageWrapper.astro";

const config = profileConfig;
const BLOG_NAME = "Kairo Blog";
---

<div class="card-base p-3">
  <a
    aria-label={"Avatar - " + BLOG_NAME}
    href={url("#")}
    class="group block relative mx-auto mt-1 mb-3 max-w-[12rem] overflow-hidden rounded-xl active:scale-95"
  >
    <div
      class="absolute inset-0 pointer-events-none transition
             group-hover:bg-black/30 group-active:bg-black/50
             z-10 flex items-center justify-center"
    >
      <Icon
        name="fa6-regular:address-card"
        class="text-white text-5xl transition
               opacity-0 scale-90
               group-hover:opacity-100 group-hover:scale-100"
      />
    </div>

    <ImageWrapper
      src={config.avatar || ""}
      alt="Profile Image"
      class="mx-auto w-full h-full"
    />
  </a>

  <div class="px-2">
    <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50">
      {config.name}
    </div>

    <div class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2"></div>

    <div class="text-center text-neutral-400 mb-2.5">
      {config.bio}
    </div>

    <div class="flex flex-wrap gap-2 justify-center mb-1">
      {config.links?.length > 1 &&
        config.links.map(item => (
          <a
            rel="me"
            aria-label={item.name}
            href={item.url}
            target="_blank"
            class="btn-regular rounded-lg h-10 w-10 active:scale-90"
          >
            <Icon name={item.icon} class="text-[1.5rem]" />
          </a>
        ))}

      {config.links?.length === 1 && (
        <a
          rel="me"
          aria-label={config.links[0].name}
          href={config.links[0].url}
          target="_blank"
          class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95"
        >
          <Icon name={config.links[0].icon} class="text-[1.5rem]" />
          {config.links[0].name}
        </a>
      )}
    </div>

    <div
      class="grid grid-cols-2 mt-3 pt-3
             border-t border-neutral-200 dark:border-neutral-700"
    >
      <div class="text-center">
        <div class="text-xs text-neutral-500 mb-1 flex items-center justify-center gap-1">
          <Icon name="material-symbols:visibility-outline" class="text-base" />
          <span>訪問量</span>
        </div>
        <div
          id="site-views"
          class="font-bold text-lg text-neutral-700 dark:text-neutral-300"
        >
          載入中…
        </div>
      </div>

      <div class="text-center border-l border-neutral-200 dark:border-neutral-700">
        <div class="text-xs text-neutral-500 mb-1 flex items-center justify-center gap-1">
          <Icon name="material-symbols:person" class="text-base" />
          <span>訪客數</span>
        </div>
        <div
          id="site-visitors"
          class="font-bold text-lg text-neutral-700 dark:text-neutral-300"
        >
          載入中…
        </div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ umamiConfig }} type="module">
  async function loadUmamiStats() {
    const viewsEl = document.getElementById("site-views");
    const visitorsEl = document.getElementById("site-visitors");

    if (!viewsEl || !visitorsEl) return;

    if (!umamiConfig?.enable || !umamiConfig?.baseUrl || !umamiConfig?.shareId) {
      viewsEl.textContent = "-";
      visitorsEl.textContent = "-";
      return;
    }

    try {
      const base = String(umamiConfig.baseUrl).replace(/\/+$/, "");
      const shareId = String(umamiConfig.shareId);

      const apiUrl = `${base}/share/${shareId}/stats`;

      const res = await fetch(apiUrl, { method: "GET" });
      if (!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json();

      // Share API 固定格式
      const pageviews = Number(data.pageviews) || 0;
      const visitors = Number(data.visitors) || 0;

      viewsEl.textContent = pageviews.toLocaleString();
      visitorsEl.textContent = visitors.toLocaleString();
    } catch (err) {
      console.error("[Umami] stats load failed:", err);
      viewsEl.textContent = "-";
      visitorsEl.textContent = "-";
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", loadUmamiStats);
  } else {
    loadUmamiStats();
  }
</script>
