---
import { Icon } from "astro-icon/components";
import { profileConfig, umamiConfig } from "../../config";
import ImageWrapper from "../misc/ImageWrapper.astro";
import WidgetLayout from "./WidgetLayout.astro";

const config = profileConfig;
---
<div class="card-base p-3">
  <a aria-label="Avatar - Kairo Blog" href="#" class="group block relative mx-auto mt-1 mb-3 max-w-[12rem] overflow-hidden rounded-xl active:scale-95">
    <div class="absolute inset-0 pointer-events-none transition group-hover:bg-black/30 group-active:bg-black/50 z-10 flex items-center justify-center">
      <Icon name="fa6-regular:address-card" class="text-white text-5xl transition opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100" />
    </div>

    <ImageWrapper src={config.avatar || ""} alt="Profile Image" class="mx-auto w-full h-full" />
  </a>

  <div class="px-2">
    <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50">{config.name}</div>
    <div class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2"></div>
    <div class="text-center text-neutral-400 mb-2.5">{config.bio}</div>

    <div class="flex flex-wrap gap-2 justify-center mb-1">
      {config.links && config.links.length > 1 &&
        config.links.map(function (item) {
          return (
            <a rel="me" aria-label={item.name} href={item.url} target="_blank" class="btn-regular rounded-lg h-10 w-10 active:scale-90">
              <Icon name={item.icon} class="text-[1.5rem]" />
            </a>
          );
        })
      }

      {config.links && config.links.length === 1 && (
        <a rel="me" aria-label={config.links[0].name} href={config.links[0].url} target="_blank" class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95">
          <Icon name={config.links[0].icon} class="text-[1.5rem]" />
          {config.links[0].name}
        </a>
      )}
    </div>

    <!-- 替換後的統計 widget（原封不動插入的統計區塊，已整合到 Profile.astro） -->
    <WidgetLayout name="统计" id="umami-stats">
        <div class="text-center py-2">
            <div class="text-3xl font-bold text-neutral-900 dark:text-neutral-100" id="total-pageviews">-</div>
            <div class="text-sm text-neutral-500 dark:text-neutral-400">总浏览量</div>
        </div>
        <div class="grid grid-cols-2 divide-x divide-neutral-200 dark:divide-neutral-700 text-center pt-2">
            <div class="px-2">
                <div class="text-xl font-bold text-neutral-900 dark:text-neutral-100" id="total-visits">-</div>
                <div class="text-sm text-neutral-500 dark:text-neutral-400">访问数</div>
            </div>
            <div class="px-2">
                <div class="text-xl font-bold text-neutral-900 dark:text-neutral-100" id="total-visitors">-</div>
                <div class="text-sm text-neutral-500 dark:text-neutral-400">游客数</div>
            </div>
        </div>
    </WidgetLayout>

  </div>
</div>

<script>
/* 将站点端配置注入前端的 UMAMI_CONFIG（由 build-time umamiConfig 填充） */
const UMAMI_CONFIG = ${JSON.stringify({
  baseUrl: umamiConfig?.baseUrl || "",
  websiteId: umamiConfig?.websiteId || umamiConfig?.shareId || umamiConfig?.siteId || "",
  shareToken: process.env.UMAMI_TOKEN
})};

function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return String(num);
}

async function fetchUmamiStats() {
    try {
        const endAt = Date.now();
        const startAt = 0;

        const url = `${UMAMI_CONFIG.baseUrl}/websites/${UMAMI_CONFIG.websiteId}/stats?startAt=${startAt}&endAt=${endAt}&unit=hour&timezone=Asia%2FShanghai`;

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'accept': 'application/json',
                'x-umami-share-token': UMAMI_CONFIG.shareToken
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const pageviewsElement = document.getElementById('total-pageviews');
        const visitsElement = document.getElementById('total-visits');
        const visitorsElement = document.getElementById('total-visitors');

        if (pageviewsElement) {
            pageviewsElement.textContent = formatNumber(data.pageviews || 0);
        }

        if (visitsElement) {
            visitsElement.textContent = formatNumber(data.visits || 0);
        }

        if (visitorsElement) {
            visitorsElement.textContent = formatNumber(data.visitors || 0);
        }

    } catch (error) {
        console.error('获取Umami统计数据失败:', error);
        const elements = ['total-pageviews', 'total-visits', 'total-visitors'];
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = '获取失败';
                element.classList.add('text-red-500');
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', fetchUmamiStats);

if (window.swup) {
    window.swup.hooks.on('page:view', fetchUmamiStats);
}
</script>
