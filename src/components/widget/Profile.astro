---
import { Icon } from "astro-icon/components";
import { profileConfig } from "../../config";
import ImageWrapper from "../misc/ImageWrapper.astro";

const config = profileConfig || {};
const initialOneLiner = config.oneLiner || config.tagline || config['一句話'] || "";
---
<div class="card-base p-3">
  <!-- 頭像 -->
  <a
    aria-label="Avatar - Kairo Blog"
    href="#"
    class="group block relative mx-auto mt-1 mb-3 max-w-[12rem] h-[12rem] overflow-hidden rounded-xl active:scale-95"
  >
    <div class="absolute inset-0 pointer-events-none transition group-hover:bg-black/30 group-active:bg-black/50 z-10 flex items-center justify-center">
      <Icon name="fa6-regular:address-card" class="text-white text-5xl transition opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100" />
    </div>

    <ImageWrapper src={config.avatar || ""} alt="Profile Image" class="mx-auto w-full h-full object-cover" />
  </a>

  <!-- 名稱 -->
  <div class="px-2">
    <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50">{config.name}</div>
    <div class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2"></div>

    <!-- 描述 -->
    <div class="text-center text-neutral-400 mb-2.5">
      {config.bio}
    </div>

    <!-- 按鈕（保持原樣） -->
    <div class="flex flex-wrap gap-2 justify-center mb-3">
      {config.links && config.links.length > 1 &&
        config.links.map(function (item) {
          return (
            <a rel="me" aria-label={item.name} href={item.url} target="_blank" class="btn-regular rounded-lg h-10 w-10 active:scale-90">
              <Icon name={item.icon} class="text-[1.5rem]" />
            </a>
          );
        })
      }

      {config.links && config.links.length === 1 && (
        <a rel="me" aria-label={config.links[0].name} href={config.links[0].url} target="_blank" class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95">
          <Icon name={config.links[0].icon} class="text-[1.5rem]" />
          {config.links[0].name}
        </a>
      )}
    </div>

    <!-- 內部淺淺分隔線（不把卡片分開） + 一言（API 載入）-->
    <div class="pt-2">
      <div class="mx-4 border-t border-neutral-200/30 dark:border-neutral-700/30"></div>

      <div class="mt-2 text-center text-sm text-neutral-500 dark:text-neutral-400 italic px-3">
        <!-- 先顯示 config 裡的 fallback（若有），之後 client-side script 會覆蓋為 API 結果 -->
        <div id="poem_container" class="flex flex-col items-center gap-1">
          <div id="poem_sentence" class="whitespace-pre-wrap leading-tight"></div>
          <div id="poem_info" class="text-xs text-neutral-400"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 引入今日詩詞 SDK 並載入（client-side only） -->
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8" defer></script>
<script type="text/javascript">
  (function () {
    // 先把 fallback 文本放到容器（若 config 裡有一言）
    const initial = `<!--FALLBACK-->`.replace('<!--FALLBACK-->', ` ${initialOneLiner || ''}`.trim());
    const sentenceEl = document.getElementById('poem_sentence');
    const infoEl = document.getElementById('poem_info');

    if (sentenceEl && initial) {
      sentenceEl.textContent = initial;
    }

    // 根據字數調整字級的函式（以字數為基準）
    function adjustFontSizeByLength(el) {
      if (!el) return;
      const text = el.textContent ? el.textContent.trim() : '';
      const len = Array.from(text).length; // 更穩健地計算字元數（支援多字元）
      // 分級策略（可微調）：
      // <=20: 18px; 21-40: 16px; 41-60: 14px; 61-100: 13px; >100: 12px
      let fontSize = 18;
      if (len <= 20) fontSize = 18;
      else if (len <= 40) fontSize = 16;
      else if (len <= 60) fontSize = 14;
      else if (len <= 100) fontSize = 13;
      else fontSize = 12;

      el.style.fontSize = fontSize + 'px';
      // 行高與字級做些優化
      el.style.lineHeight = 1.2;
      el.style.maxWidth = '100%';
    }

    // 等 SDK 載入完，呼叫 jinrishici
    function tryLoadJinrishici() {
      try {
        if (typeof jinrishici === 'undefined' || !jinrishici.load) {
          // SDK 尚未載入或不支援，保留 fallback
          adjustFontSizeByLength(sentenceEl);
          return;
        }

        jinrishici.load(function (result) {
          try {
            if (!result || !result.data) {
              adjustFontSizeByLength(sentenceEl);
              return;
            }

            // 句子內容
            const content = (result.data.content || '').trim();
            // 來源資訊：朝代、作者、詩名（有些資料可能不存在）
            const origin = result.data.origin || {};
            const dynasty = origin.dynasty || '';
            const author = origin.author || '';
            const title = origin.title || '';

            if (sentenceEl) {
              sentenceEl.textContent = content || (initial || '');
              adjustFontSizeByLength(sentenceEl);
            }

            if (infoEl) {
              const pieces = [];
              if (dynasty) pieces.push('【' + dynasty + '】');
              if (author) pieces.push(author);
              if (title) pieces.push('《' + title + '》');
              infoEl.textContent = pieces.join(' ');
            }
          } catch (err) {
            console.error('jinrishici callback error:', err);
            adjustFontSizeByLength(sentenceEl);
          }
        });
      } catch (e) {
        console.error('Failed to load jinrishici:', e);
        adjustFontSizeByLength(sentenceEl);
      }
    }

    // 如果 document 已完成載入就直接呼叫，否則等 DOMContentLoaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      // 延遲一個 tick，等 defer script 真正執行完
      setTimeout(tryLoadJinrishici, 50);
    } else {
      document.addEventListener('DOMContentLoaded', function () {
        setTimeout(tryLoadJinrishici, 50);
      });
    }
  })();
</script>
