---
interface Route {
  name: string;
  key: string;
  url: string;
  pingUrl?: string;
}

// 修改這裡就可以新增 / 改路線
const routes: Route[] = [
  { name: "Vercel", key: "vercel", url: "https://kairo.qzz.io", pingUrl: "https://kairo.qzz.io" },
  { name: "EdgeOne", key: "edgeone", url: "https://edge.kairo.qzz.io", pingUrl: "https://edge.kairo.qzz.io" },
];

// 預設（可改）
const defaultRoute = "vercel";
// 點擊後再等多少 ms 再跳轉（可改）
const redirectDelay = 250;
---
<div class="rsw-widget rsw-card" role="region" aria-label="路線切換">
  <div class="rsw-header">
    <div class="rsw-title">路線選擇</div>
    <div class="rsw-sub">選擇部署 / 路線</div>
  </div>

  <div class="rsw-buttons" role="tablist" aria-label="路線列表">
    {routes.map((r) => (
      <button
        type="button"
        class="rsw-btn"
        data-key={r.key}
        data-url={r.url}
        data-ping={r.pingUrl ?? r.url}
        aria-pressed={r.key === defaultRoute ? "true" : "false"}
      >
        <span class="rsw-name">{r.name}</span>
        <span class="rsw-ping" aria-live="polite">— ms</span>
      </button>
    ))}
  </div>
</div>

<style is:inline>
/* ===== RouteSwitch 內嵌樣式（保守、低衝突） ===== */
.rsw-card {
  --bg: var(--card-bg, white);
  --border: var(--card-border, rgba(0,0,0,0.06));
  --hover: var(--card-bg-hover, rgba(0,0,0,0.02));
  --accent: oklch(0.72 0.12 var(--hue, 220));
  border: 1px solid var(--border);
  background: var(--bg);
  padding: 0.6rem;
  border-radius: 0.6rem;
  box-shadow: 0 1px 0 rgba(0,0,0,0.02);
  font-family: inherit;
  color: inherit;
}
.rsw-header { display:flex; flex-direction:column; gap:0.125rem; margin-bottom:0.5rem; }
.rsw-title { font-size:0.95rem; font-weight:600; }
.rsw-sub { font-size:0.72rem; opacity:0.7; }

/* 按鈕區 */
.rsw-buttons { display:flex; gap:0.5rem; }
.rsw-btn {
  flex:1 1 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:0.5rem;
  padding:0.5rem 0.6rem;
  border-radius:0.5rem;
  border:1px solid var(--border);
  background:transparent;
  cursor:pointer;
  transition:all 0.18s ease;
  font-size:0.9rem;
}
.rsw-btn:hover { background:var(--hover); }
.rsw-btn:active { transform: translateY(1px); }

/* 當前路線樣式 */
.rsw-btn.active,
.rsw-btn[aria-pressed="true"] {
  background: var(--accent);
  color: white;
  border-color: transparent;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}

/* 名稱與延遲 */
.rsw-name { font-weight:500; }
.rsw-ping { font-size:0.78rem; opacity:0.85; }

/* 小螢幕優化 */
@media (max-width:420px) {
  .rsw-title { font-size:0.9rem; }
  .rsw-btn { padding:0.45rem 0.5rem; font-size:0.86rem; }
}
</style>

<script is:inline>
(function () {
  // 這裡把 server-side 的 routes 注入到 client 腳本
  const ROUTES = JSON.parse(`${JSON.stringify(routes)}`);
  const DEFAULT = `${defaultRoute}`;
  const REDIRECT_DELAY = ${redirectDelay};

  function fmt(ms) {
    if (ms === null || ms === undefined) return '— ms';
    return ms + ' ms';
  }

  // 用 Image 來做 ping 測時（跨域更穩定）
  function pingImage(url, timeout = 4000) {
    return new Promise((resolve) => {
      if (!url) { resolve(null); return; }
      const img = new Image();
      const start = performance.now();
      let done = false;

      const clean = (ms) => {
        if (done) return;
        done = true;
        // small delay to avoid weird 0ms
        setTimeout(() => resolve(Math.max(1, Math.round(ms))), 0);
      };

      const timer = setTimeout(() => {
        img.src = ''; // cancel
        clean(performance.now() - start);
      }, timeout);

      img.onload = () => { clearTimeout(timer); clean(performance.now() - start); };
      img.onerror = () => { clearTimeout(timer); clean(performance.now() - start); };

      // 防止被 cache 影響時間，加亂數 query
      const sep = url.includes('?') ? '&' : '?';
      try {
        img.src = url + sep + '_rsw_ping=' + Date.now();
      } catch (e) {
        clearTimeout(timer);
        clean(null);
      }
    });
  }

  function init() {
    const root = document.querySelector('.rsw-widget');
    if (!root) return;
    const buttons = Array.from(root.querySelectorAll('.rsw-btn'));

    // 優先 localStorage 記憶選擇
    let initial = DEFAULT;
    try { const s = localStorage.getItem('rsw:selected'); if (s) initial = s; } catch (e) {}

    // 初始化按鈕狀態與 ping
    buttons.forEach((btn) => {
      const key = btn.dataset.key;
      const url = btn.dataset.url;
      const pingUrl = btn.dataset.ping || url;
      const pingEl = btn.querySelector('.rsw-ping');

      // UI 初始
      if (key === initial) {
        btn.classList.add('active');
        btn.setAttribute('aria-pressed', 'true');
      } else {
        btn.classList.remove('active');
        btn.setAttribute('aria-pressed', 'false');
      }

      // 顯示 loading 樣式
      pingEl.textContent = '… ms';

      // 執行 ping（使用 image），並更新 ms
      // 如果 pingUrl 看起來像是 HTML 頁面，也沒關係
      pingImage(pingUrl).then(ms => {
        pingEl.textContent = fmt(ms);
      });

      // 點擊事件：切 UI -> 儲存 -> 延遲跳轉
      btn.addEventListener('click', () => {
        // 切換 UI
        buttons.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed', 'false'); });
        btn.classList.add('active'); btn.setAttribute('aria-pressed', 'true');

        try { localStorage.setItem('rsw:selected', btn.dataset.key); } catch (e) {}

        setTimeout(() => {
          window.location.href = url;
        }, REDIRECT_DELAY);
      }, { passive: true });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
