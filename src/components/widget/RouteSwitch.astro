---
import { Icon } from "astro-icon/components";

interface Route {
  name: string;
  key: string;
  url: string;
  pingUrl?: string;
}

/**
 * 路線設定（你要改只要改這裡）
 * Vercel:     https://kairo.qzz.io
 * EdgeOne:    https://edge.kairo.qzz.io
 * Cloudflare: https://cf.kairo.qzz.io
 */
const routes: Route[] = [
  { name: "Vercel", key: "vercel", url: "https://kairo.qzz.io", pingUrl: "https://kairo.qzz.io" },
  { name: "EdgeOne", key: "edgeone", url: "https://edge.kairo.qzz.io", pingUrl: "https://edge.kairo.qzz.io" },
  { name: "Cloudflare", key: "cloudflare", url: "https://cf.kairo.qzz.io", pingUrl: "https://cf.kairo.qzz.io" },
];

const defaultRoute = "vercel";
const redirectDelay = 250;
---
<div id="route-switch" class="rsw-widget card-base p-4" role="region" aria-label="路線切換">
  <div class="flex flex-col gap-1 mb-3">
    <div class="text-sm font-semibold">路線選擇</div>
    <div class="text-xs opacity-70">切換部署 / 路線（點擊後會直接跳轉）</div>
  </div>

  <div class="flex flex-col gap-2" role="tablist" aria-label="路線列表">
    {routes.map((r) => (
      <button
        type="button"
        class="rsw-btn flex items-center justify-between w-full px-3 py-2 rounded-xl transition-colors active:translate-y-[1px] focus:outline-none"
        data-key={r.key}
        data-url={r.url}
        data-ping={r.pingUrl ?? r.url}
        aria-pressed={r.key === defaultRoute ? "true" : "false"}
      >
        <div class="flex items-center gap-3">
          <div class="rsw-badge flex items-center justify-center rounded-md min-w-[1.5rem] h-6 text-xs font-bold">
            <!-- 使用 astro-icon 的 Icon（真實引入） -->
            {r.key === "vercel" && <Icon name="simple-icons:vercel" class="w-4 h-4" />}
            {r.key === "edgeone" && <Icon name="fa6-solid:server" class="w-4 h-4" />}
            {r.key === "cloudflare" && <Icon name="simple-icons:cloudflare" class="w-4 h-4" />}
          </div>
          <div class="text-sm font-medium">{r.name}</div>
        </div>

        <div class="text-xs opacity-70 rsw-ping" aria-live="polite">— ms</div>
      </button>
    ))}
  </div>
</div>

<style is:inline>
/* ===== RouteSwitch 內嵌樣式（低衝突，跟 Fuwari 變數相容） ===== */
.rsw-widget {
  --accent: oklch(0.72 0.12 var(--hue, 220));
}
.rsw-btn {
  border: 1px solid var(--card-border, rgba(0,0,0,0.06));
  background: var(--card-bg, white);
  color: inherit;
}
.rsw-btn:hover {
  background: var(--card-bg-hover, rgba(0,0,0,0.02));
}
.rsw-btn[aria-pressed="true"],
.rsw-btn.active {
  background: var(--accent);
  color: white;
  border-color: transparent;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}
.rsw-badge {
  width: 28px;
  height: 24px;
  background: rgba(0,0,0,0.04);
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.rsw-btn[aria-pressed="true"] .rsw-badge {
  background: rgba(255,255,255,0.12);
}
.rsw-ping {
  min-width: 56px;
  text-align: right;
}
@media (max-width:420px) {
  .rsw-btn { padding: 0.45rem 0.5rem; font-size: 0.86rem; }
  .rsw-badge { width: 24px; height: 20px; }
}
</style>

<script is:inline>
(function () {
  const root = document.getElementById('route-switch');
  if (!root) return;

  const buttons = Array.from(root.querySelectorAll('.rsw-btn'));
  const REDIRECT_DELAY = /**/ ${redirectDelay} /**/;

  // helper
  function fmt(ms) {
    return (ms === null || ms === undefined) ? '— ms' : (ms + ' ms');
  }

  // ping via Image (cross-origin friendly)
  function pingImage(url, timeout = 4000) {
    return new Promise((resolve) => {
      if (!url) { resolve(null); return; }
      const img = new Image();
      const start = performance.now();
      let done = false;
      const timer = setTimeout(() => {
        if (!done) {
          done = true;
          resolve(null);
        }
      }, timeout);

      img.onload = () => {
        if (done) return;
        done = true;
        clearTimeout(timer);
        resolve(Math.max(1, Math.round(performance.now() - start)));
      };
      img.onerror = () => {
        if (done) return;
        done = true;
        clearTimeout(timer);
        resolve(Math.max(1, Math.round(performance.now() - start)));
      };

      try {
        const sep = url.includes('?') ? '&' : '?';
        img.src = url + sep + '_rsw_ping=' + Date.now();
      } catch (e) {
        clearTimeout(timer);
        resolve(null);
      }
    });
  }

  // initial key: localStorage > aria-pressed in markup > first button
  let initial = null;
  try { initial = localStorage.getItem('rsw:selected'); } catch (e) { initial = null; }
  if (!initial) {
    const fromMarkup = buttons.find(b => b.getAttribute('aria-pressed') === 'true')?.dataset.key;
    initial = fromMarkup || (buttons[0] && buttons[0].dataset.key);
  }

  function setActiveKey(key) {
    buttons.forEach(b => {
      const k = b.dataset.key;
      if (k === key) {
        b.classList.add('active');
        b.setAttribute('aria-pressed', 'true');
      } else {
        b.classList.remove('active');
        b.setAttribute('aria-pressed', 'false');
      }
    });
  }
  setActiveKey(initial);

  // ping on load
  buttons.forEach(btn => {
    const pingEl = btn.querySelector('.rsw-ping');
    const pingUrl = btn.dataset.ping || btn.dataset.url;
    if (pingEl) pingEl.textContent = '… ms';
    pingImage(pingUrl).then(ms => {
      if (pingEl) pingEl.textContent = fmt(ms);
    });
  });

  // click handler: set active, save, delay then redirect (no new tab)
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const url = btn.dataset.url;
      const key = btn.dataset.key;
      setActiveKey(key);
      try { localStorage.setItem('rsw:selected', key); } catch (e) {}
      setTimeout(() => {
        window.location.href = url;
      }, REDIRECT_DELAY);
    }, { passive: true });
  });
})();
</script>
