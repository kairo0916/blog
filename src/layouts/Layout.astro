---
import Analytics from '@vercel/analytics/astro'
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/500.css";
import "@fontsource/roboto/700.css";
import ReadingProgress from "@components/ReadingProgress.astro";

import ConfigCarrier from "@components/ConfigCarrier.astro";
import { profileConfig, siteConfig } from "@/config";
import ConfigCarrier from "@components/ConfigCarrier.astro";
import {
	AUTO_MODE,
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	DARK_MODE,
	DEFAULT_THEME,
	LIGHT_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { url, pathsEqual } from "../utils/url-utils";
import "katex/dist/katex.css";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
}

let { title, banner, description, lang, setOGTypeArticle } = Astro.props;

const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

const configHue = siteConfig.themeColor.hue;
banner = siteConfig.banner.src;
const enableBanner = siteConfig.banner.enable;

let pageTitle = title
	? `${title} - ${siteConfig.title}`
	: siteConfig.subtitle
		? `${siteConfig.title} - ${siteConfig.subtitle}`
		: siteConfig.title;

if (!description) description = siteConfig.description || pageTitle;

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

if (!lang) lang = siteConfig.lang;
const siteLang = lang.replace("_", "-");
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] transition text-[12px] md:text-[16px]">
<head>
	<title>{pageTitle}</title>

	<meta charset="UTF-8" />
	<meta name="description" content={description}>
	<meta name="author" content={profileConfig.name}>
	<meta name="viewport" content="width=device-width" />

	<meta property="og:site_name" content={siteConfig.title}>
	<meta property="og:title" content={pageTitle}>
	<meta property="og:description" content={description}>
	<meta property="og:type" content={setOGTypeArticle ? "article" : "website"}>

	<meta name="twitter:card" content="summary_large_image">

	{favicons.map(favicon => (
		<link rel="icon"
			href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
			sizes={favicon.sizes}
			media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
		/>
	))}

		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

        <script defer src="https://cloud.umami.is/script.js" data-website-id="7084c8b9-50af-4d0b-9d61-28213659fbe1"></script>

		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue}}>
            if (forceDarkMode) {
				document.documentElement.classList.add('dark');
				localStorage.setItem('theme', DARK_MODE);
			} else {
			// Load the theme from local storage
	<script is:inline define:vars={{
		DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE,
		BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue,
		forceDarkMode: siteConfig.themeColor.forceDarkMode
	}}>
		if (forceDarkMode) {
			document.documentElement.classList.add('dark');
			localStorage.setItem('theme', DARK_MODE);
		} else {
			const theme = localStorage.getItem('theme') || DEFAULT_THEME;
			if (theme === DARK_MODE) document.documentElement.classList.add('dark');
			else document.documentElement.classList.remove('dark');
		}
		const hue = localStorage.getItem('hue') || configHue;
		document.documentElement.style.setProperty('--hue', hue);

		let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
		offset -= offset % 4;
		document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
	</script>

			// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
			let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
			offset = offset - offset % 4;
			document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);

        // Background image loading detection
			const bgUrl = getComputedStyle(document.documentElement).getPropertyValue('--bg-url').trim();
			const bgEnable = getComputedStyle(document.documentElement).getPropertyValue('--bg-enable').trim();
			
			if (bgUrl && bgUrl !== 'none' && bgEnable === '1') {
				const img = new Image();
				const urlMatch = bgUrl.match(/url\(["']?([^"')]+)["']?\)/);
				if (urlMatch) {
					img.onload = function() {
						// 背景图片完全加载后，显示背景并启用卡片透明效果
						document.body.classList.add('bg-loaded');
						document.documentElement.style.setProperty('--card-bg', 'var(--card-bg-transparent)');
						document.documentElement.style.setProperty('--float-panel-bg', 'var(--float-panel-bg-transparent)');
					};
					img.onerror = function() {
						// Keep cards opaque if background image fails to load
						console.warn('Background image failed to load, keeping cards opaque');
					};
					img.src = urlMatch[1];
				}
			}
		</script>
		<style define:vars={{
			configHue,
			'page-width': `${PAGE_WIDTH}rem`,
			'bg-url': siteConfig.background.src ? `url(${siteConfig.background.src})` : 'none',
			'bg-enable': siteConfig.background.enable ? '1' : '0',
			'bg-position': siteConfig.background.position || 'center',
			'bg-size': siteConfig.background.size || 'cover',
			'bg-repeat': siteConfig.background.repeat || 'no-repeat',
			'bg-attachment': siteConfig.background.attachment || 'fixed',
			'bg-opacity': (siteConfig.background.opacity || 0.3).toString()
		}}>
			:root {
				--bg-url: var(--bg-url);
				--bg-enable: var(--bg-enable);
				--bg-position: var(--bg-position);
				--bg-size: var(--bg-size);
				--bg-repeat: var(--bg-repeat);
				--bg-attachment: var(--bg-attachment);
				--bg-opacity: var(--bg-opacity);
			}
			
			/* Background image configuration */
			body {
				--bg-url: var(--bg-url);
				--bg-enable: var(--bg-enable);
				--bg-position: var(--bg-position);
				--bg-size: var(--bg-size);
				--bg-repeat: var(--bg-repeat);
				--bg-attachment: var(--bg-attachment);
				--bg-opacity: var(--bg-opacity);
			}

			#bg-box {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-position: var(--bg-position);
				background-size: var(--bg-size);
				background-repeat: var(--bg-repeat);
				background-attachment: var(--bg-attachment);
				opacity: 0;
				pointer-events: none;
				z-index: -1;
				transition: opacity 0.3s ease-in-out;
			}
			
			#bg-box.loaded {
				opacity: calc(var(--bg-opacity) * var(--bg-enable));
			}
		</style>
	<style define:vars={{
		'page-width': `${PAGE_WIDTH}rem`,
		'bg-url': siteConfig.background.src ? `url(${siteConfig.background.src})` : 'none',
		'bg-enable': siteConfig.background.enable ? '1' : '0',
		'bg-size': siteConfig.background.size || 'cover',
		'bg-position': siteConfig.background.position || 'center',
		'bg-repeat': siteConfig.background.repeat || 'no-repeat',
		'bg-attachment': siteConfig.background.attachment || 'fixed',
		'bg-opacity': (siteConfig.background.opacity || 0.3).toString()
	}}>
	body::before {
		content: '';
		position: fixed;
		inset: 0;
		background-image: var(--bg-url);
		background-size: var(--bg-size);
		background-position: var(--bg-position);
		background-repeat: var(--bg-repeat);
		background-attachment: var(--bg-attachment);
		opacity: calc(var(--bg-opacity) * var(--bg-enable));
		z-index: -1;
		pointer-events: none;
	}
	</style>

	<slot name="head" />
</head>

		<slot name="head"></slot>

        <!-- 域名偵測腳本 -->
		<script is:inline define:vars={{officialSites: siteConfig.officialSites || []}}>
		
			function checkDomain() {
				try {
	
					const currentUrl = window.location.href;
				
					const currentDomain = window.location.hostname;
					
		
					const officialDomains = "https://www.kairo.qzz.io", "https://kairo.qzz.io", "https://blog.kairo.qzz.io"
					
		
					const isOfficialDomain = officialDomains.some(officialDomain => 
                        currentDomain === officialDomain || currentDomain.endsWith('.' + officialDomain)
                    );
					const isLocalDev = currentDomain === 'localhost' || currentDomain === '127.0.0.1';
					
			
					if (!isOfficialDomain && !isLocalDev) {
						const shouldRedirect = confirm(
							`⚠️ 域名安全警告\n\n` +
							`您當前訪問的域名：${currentDomain}\n` +
							`官方域名：${officialDomains.join(', ')}\n\n` +
							`您可能正在訪問非官方網站，可能存在風險！\n\n` +
							`點擊“確定”跳轉到官方網站\n` +
							`點擊“取消”繼續訪問此網站（不推薦）`
						);
						
				
						if (shouldRedirect) {
				
							const currentPath = window.location.pathname + window.location.search + window.location.hash;
                            const firstSite = officialSites[0];
                            const firstUrl = typeof firstSite === 'string' ? firstSite : firstSite.url;
							const officialPageUrl = firstUrl + currentPath;
							// 跳转到官方网站
							window.location.href = officialPageUrl;
						}
					}
				} catch (error) {
					console.warn('域名檢測失敗', error);
				}
			}
			
	
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', checkDomain);
			} else {
				checkDomain();
			}
		</script>

        <!-- Umami -->
        <script defer src="https://umami.kairo.qzz.io/script.js" data-website-id="999c53a8-bdcf-4bea-aa2a-645f270d3e5b"></script>

        <!--Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-RDHQRP2G0Z"></script>
    <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

       gtag('config', 'G-RDHQRP2G0Z');
    </script>

        <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "fa504ac1a9c94469a2b0a0d1133a5b56"}'></script><!-- End Cloudflare Web Analytics -->

		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>

	</head>
	<body class=" min-h-screen transition " class:list={[{"lg:is-home": isHomePage, "enable-banner": enableBanner}]}
		  data-overlayscrollbars-initialize
	>
		<ConfigCarrier></ConfigCarrier>

        <ReadingProgress />

		<slot />

		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>
	</body>
<body class:list={[{"lg:is-home": isHomePage, "enable-banner": enableBanner}]}>
	<ConfigCarrier />
	<slot />
	<Analytics />
</body>
</html>
