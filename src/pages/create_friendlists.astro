---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { siteConfig } from "../config";
const title = "申请友链";
---
<MainGridLayout title={title} description="申请友链" lang={siteConfig.lang}>
  <div class="max-w-[var(--page-width)] mx-auto px-4 md:px-6 py-8">
    <div class="mb-6 onload-animation">
      <h1 class="text-3xl font-bold mb-2">申请友链</h1>
      <p class="text-sm text-75">请按要求填写，下方可直接复制申请文本或新建 GitHub Issue（lssus）。</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- FORM -->
      <form id="fl-form" class="card-base p-6 col-span-2" on:submit="return false;">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <!-- 网站名称 -->
          <label class="flex flex-col md:col-span-2">
            <span class="text-sm font-medium mb-2">网站名称 *</span>
            <input id="siteName" required placeholder="例如：Kairo's Blog"
                   class="px-3 py-2 rounded-md border border-[var(--line-color)]" />
          </label>

          <!-- 网站链接 -->
          <label class="flex flex-col md:col-span-2">
            <span class="text-sm font-medium mb-2">网站链接 *</span>
            <input id="siteUrl" required placeholder="https://example.com"
                   class="px-3 py-2 rounded-md border border-[var(--line-color)]" />
          </label>

          <!-- 网站描述 -->
          <label class="flex flex-col md:col-span-2">
            <span class="text-sm font-medium mb-2">网站描述 *（一句话）</span>
            <textarea id="description" rows="4" required placeholder="一句话介绍网站内容"
                      class="px-3 py-2 rounded-md border border-[var(--line-color)]"></textarea>
          </label>

          <!-- 头像地址 -->
          <label class="flex flex-col">
            <span class="text-sm font-medium mb-2">头像地址</span>
            <input id="avatarUrl" placeholder="https://example.com/avatar.png"
                   class="px-3 py-2 rounded-md border border-[var(--line-color)]" />
          </label>

          <!-- 分类 -->
          <label class="flex flex-col">
            <span class="text-sm font-medium mb-2">分类 *</span>
            <select id="category" required class="px-3 py-2 rounded-md border border-[var(--line-color)]">
              <option value="" disabled selected>请选择</option>
              <option>技术</option>
              <option>分享</option>
              <option>学习</option>
              <option>交流</option>
              <option>生活</option>
              <option>其他</option>
            </select>
          </label>

          <!-- 其他分类（隐藏/显示） -->
          <label id="other-wrap" class="flex flex-col hidden md:flex md:col-span-2">
            <span class="text-sm font-medium mb-2">其他分类（请填写）</span>
            <input id="otherCategory" class="px-3 py-2 rounded-md border border-[var(--line-color)]" />
          </label>

          <!-- 联系邮箱 -->
          <label class="flex flex-col">
            <span class="text-sm font-medium mb-2">联络邮箱 *</span>
            <input id="contactEmail" type="email" required placeholder="name@example.com"
                   class="px-3 py-2 rounded-md border border-[var(--line-color)]" />
          </label>

          <!-- Github 用户名 -->
          <label class="flex flex-col">
            <span class="text-sm font-medium mb-2">GitHub 用户名</span>
            <input id="github" placeholder="例如 kairo0916"
                   class="px-3 py-2 rounded-md border border-[var(--line-color)]" />
          </label>

          <!-- Checkbox -->
          <div class="flex items-center gap-3 md:col-span-2">
            <input id="addedLink" type="checkbox" class="w-4 h-4" />
            <label for="addedLink" class="text-sm">我已在我的网站上添加了本博客的链接 *</label>
          </div>

        </div>

        <div id="form-msg" class="mt-4 text-sm text-red-500"></div>

        <div class="mt-6 flex gap-3 items-center">
          <button id="submitBtn" class="btn-regular px-4 py-2 rounded-lg">生成申请（预览）</button>
          <button id="resetBtn" type="button" class="btn-plain px-4 py-2 rounded-lg">重置</button>
          <div id="doneTip" class="text-sm text-75 ml-2 hidden">✔ 已生成</div>
        </div>
      </form>

      <!-- SIDE: 申请要求 + 预览/操作 -->
      <aside class="space-y-6">

        <div class="card-base p-6">
          <h3 class="font-bold mb-3">申请要求</h3>
          <ul class="text-sm space-y-2">
            <li>✅ 活跃且可访问</li>
            <li>✅ 优质内容</li>
            <li>✅ 已在你的网站上添加本博客链接</li>
            <li>✅ 内容适当且安全（无违法/成人/恶意内容）</li>
          </ul>
        </div>

        <div id="previewCard" class="card-base p-6 hidden">
          <h3 class="font-bold mb-2">预览：申请内容（Markdown）</h3>
          <pre id="previewText" class="text-sm whitespace-pre-wrap break-words bg-transparent p-0 m-0"></pre>

          <div class="mt-4 flex gap-2">
            <button id="copyBtn" class="btn-card px-3 py-2 rounded-lg">复制内容</button>
            <a id="issueBtn" class="btn-regular px-3 py-2 rounded-lg" target="_blank" rel="noopener">在 GitHub 新建 lssus</a>
            <button id="closePreview" class="btn-plain px-3 py-2 rounded-lg">关闭</button>
          </div>

          <p class="text-xs text-50 mt-3">不想 Fork 仓库？可直接点击「在 GitHub 新建 lssus」把申请发到仓库 Issues。</p>
        </div>

      </aside>
    </div>
  </div>

  <script>
    (function(){
      const siteName = document.getElementById('siteName');
      const siteUrl = document.getElementById('siteUrl');
      const description = document.getElementById('description');
      const avatarUrl = document.getElementById('avatarUrl');
      const category = document.getElementById('category');
      const otherWrap = document.getElementById('other-wrap');
      const otherCategory = document.getElementById('otherCategory');
      const contactEmail = document.getElementById('contactEmail');
      const github = document.getElementById('github');
      const addedLink = document.getElementById('addedLink');

      const submitBtn = document.getElementById('submitBtn');
      const resetBtn = document.getElementById('resetBtn');
      const formMsg = document.getElementById('form-msg');
      const previewCard = document.getElementById('previewCard');
      const previewText = document.getElementById('previewText');
      const copyBtn = document.getElementById('copyBtn');
      const issueBtn = document.getElementById('issueBtn');
      const closePreview = document.getElementById('closePreview');
      const doneTip = document.getElementById('doneTip');

      // show other when needed
      function toggleOther() {
        if (category.value === '其他') {
          otherWrap.classList.remove('hidden');
          otherCategory.required = true;
        } else {
          otherWrap.classList.add('hidden');
          otherCategory.required = false;
          otherCategory.value = '';
        }
      }
      category.addEventListener('change', toggleOther);
      toggleOther();

      function isValidUrl(u) {
        try {
          const p = new URL(u);
          return p.protocol === 'http:' || p.protocol === 'https:';
        } catch (e) {
          return false;
        }
      }

      function validate(data) {
        if (!data.siteName.trim()) return '请填写网站名称。';
        if (!data.siteUrl.trim() || !isValidUrl(data.siteUrl.trim())) return '请填写有效的网站链接（含 http(s)://）。';
        if (!data.description.trim()) return '请填写网站描述。';
        if (!data.contactEmail.trim() || !/^\S+@\S+\.\S+$/.test(data.contactEmail.trim())) return '请填写有效的联系邮箱。';
        if (!data.addedLink) return '请确认已在你的网站上添加本博客的链接。';
        if (data.category === '其他' && !data.otherCategory.trim()) return '请选择“其他”并填写分类。';
        return null;
      }

      function buildMd(data) {
        const cat = data.category === '其他' ? `其他：${data.otherCategory}` : data.category;
        return [
          `### 友链申请：${data.siteName}`,
          `- 网站：${data.siteUrl}`,
          `- 描述：${data.description}`,
          `- 头像：${data.avatarUrl || '（无）'}`,
          `- 分类：${cat}`,
          `- 联系邮箱：${data.contactEmail}`,
          `- GitHub：${data.github || '（无）'}`,
          `- 已添加本站链接：${data.addedLink ? '是' : '否'}`,
          ``,
          `> （管理员请审核并添加）`
        ].join('\n');
      }

      function buildIssueUrl(title, body) {
        const owner = 'kairo0916';
        const repo = 'blog';
        // 使用 GitHub 的新 issue URL 预填 title & body
        return `https://github.com/${owner}/${repo}/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;
      }

      submitBtn.addEventListener('click', () => {
        formMsg.textContent = '';
        const data = {
          siteName: siteName.value || '',
          siteUrl: siteUrl.value || '',
          description: description.value || '',
          avatarUrl: avatarUrl.value || '',
          category: category.value || '',
          otherCategory: otherCategory.value || '',
          contactEmail: contactEmail.value || '',
          github: github.value || '',
          addedLink: !!addedLink.checked
        };

        const err = validate(data);
        if (err) {
          formMsg.textContent = err;
          window.scrollTo({top: 0, behavior: 'smooth'});
          return;
        }

        const md = buildMd(data);
        previewText.textContent = md;
        previewCard.classList.remove('hidden');
        doneTip.classList.remove('hidden');

        // 设定 issue 链接
        const issueTitle = `友链申请：${data.siteName}`;
        const issueUrl = buildIssueUrl(issueTitle, md);
        issueBtn.href = issueUrl;
      });

      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(previewText.textContent);
          copyBtn.textContent = '已复制 ✓';
          setTimeout(()=> copyBtn.textContent = '复制内容', 1800);
        } catch (e) {
          alert('复制失败，请手动选择并复制内容。');
        }
      });

      closePreview.addEventListener('click', () => {
        previewCard.classList.add('hidden');
      });

      resetBtn.addEventListener('click', () => {
        siteName.value = '';
        siteUrl.value = '';
        description.value = '';
        avatarUrl.value = '';
        category.value = '';
        otherCategory.value = '';
        contactEmail.value = '';
        github.value = '';
        addedLink.checked = false;
        toggleOther();
        formMsg.textContent = '';
        previewCard.classList.add('hidden');
        doneTip.classList.add('hidden');
      });

    })();
  </script>
</MainGridLayout>
