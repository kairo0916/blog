---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { Icon } from "astro-icon/components";
import type { Friend } from "@/types/data";
import { siteConfig } from "@/config";

const friends = Object.values(import.meta.glob<Friend>("@/data/friends/*.json", { eager: true, import: "default" }));
---

<MainGridLayout title="友鏈">
  <div class="friends-wrap card-base p-6 md:p-8">
    <div class="header flex items-center gap-3 mb-6">
      <div class="badge">
        <Icon name="material-symbols:diversity-3" class="icon" />
      </div>
      <h1 class="title">友鏈</h1>
    </div>

    <p class="hint text-sm text-muted mb-6">
      想加入友鏈？請建立 PR 或聯絡管理員，通過審核後會收錄在此處。
    </p>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {friends.map((friend) => (
        <a
          class="friend-card"
          href={friend.url}
          target="_blank"
          rel="noopener noreferrer"
          aria-label={`開啟 ${friend.name} 的網站`}
        >
          <div class="card-top">
            <div class="avatar" style={`--hue: ${siteConfig.themeColor?.hue ?? 220}`}>
              <div class="avatar-ring" aria-hidden="true"></div>
              <img
                src={friend.avatar}
                alt={`${friend.name} 的頭像`}
                loading="lazy"
                onload="this.classList.add('is-loaded')"
              />
            </div>

            <div class="meta">
              <div class="name">{friend.name}</div>
              <div class="domain">{new URL(friend.url).hostname}</div>
            </div>

            <div class="visit" aria-hidden="true">
              <Icon name="fa6-solid:arrow-up-right-from-square" />
            </div>
          </div>

          <div class="desc">{friend.description}</div>
        </a>
      ))}
    </div>
  </div>
</MainGridLayout>

<style is:inline>
/* ---------- 變數 ---------- */
:root{
  --card-bg: rgba(255,255,255,0.02);
  --card-border: rgba(255,255,255,0.04);
  --muted: rgba(230,238,251,0.66);
  --glass-shadow: rgba(2,6,23,0.45);
}

/* wrapper */
.friends-wrap {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  color: var(--text, #e6eefb);
}

/* header */
.header .badge {
  width: 44px;
  height: 44px;
  border-radius: 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
  border: 1px solid rgba(255,255,255,0.04);
  box-shadow: 0 6px 18px rgba(2,6,23,0.25);
}
.header .icon { font-size: 1.25rem; color: var(--primary, #60A5FA); }
.title { font-size: 1.25rem; font-weight: 700; }

/* hint */
.hint { color: var(--muted); }

/* grid & card */
.friend-card {
  display: flex;
  flex-direction: column;
  gap: 0.65rem;
  padding: 14px;
  border-radius: 12px;
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  box-shadow: 0 8px 30px var(--glass-shadow);
  text-decoration: none;
  color: inherit;
  transition: transform .16s cubic-bezier(.2,.8,.2,1), box-shadow .16s ease, border-color .16s ease;
  overflow: hidden;
  min-height: 110px;
}

/* hover & focus */
.friend-card:hover,
.friend-card:focus {
  transform: translateY(-6px) scale(1.01);
  border-color: rgba(255,255,255,0.08);
  box-shadow: 0 16px 48px rgba(2,6,23,0.55);
  outline: none;
}

/* top row with avatar, meta and visit icon */
.card-top {
  display:flex;
  align-items:center;
  gap: 12px;
}

/* avatar */
.avatar {
  --size: 56px;
  width: var(--size);
  height: var(--size);
  position: relative;
  flex: 0 0 var(--size);
  border-radius: 999px;
  display: grid;
  place-items: center;
  background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  overflow: visible;
}

/* decorative gradient ring (subtle) */
.avatar-ring {
  position: absolute;
  inset: -3px;
  border-radius: 999px;
  padding: 3px;
  background: conic-gradient(from 0deg, hsl(var(--hue) 90% 60% / 1), transparent 40%, hsl(calc(var(--hue) + 60) 85% 55% / 0.9));
  filter: blur(6px);
  opacity: 0.12;
  pointer-events: none;
}

/* actual image */
.avatar img{
  width: calc(var(--size) - 6px);
  height: calc(var(--size) - 6px);
  border-radius: 999px;
  object-fit: cover;
  transform: scale(1.03);
  opacity: 0;
  transition: opacity .38s ease, transform .38s ease, filter .38s ease;
  display:block;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border: 1px solid rgba(255,255,255,0.04);
  filter: blur(6px) saturate(.9);
}

/* when loaded, reveal cleanly */
.avatar img.is-loaded {
  opacity: 1;
  transform: scale(1);
  filter: blur(0);
}

/* fallback skeleton (before image loaded) */
.avatar::before{
  content: "";
  width: calc(var(--size) - 10px);
  height: calc(var(--size) - 10px);
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  display:block;
  position: absolute;
  inset: 0;
  margin: auto;
  box-shadow: inset 0 -6px 12px rgba(0,0,0,0.15);
  z-index: 0;
}

/* meta */
.meta { display:flex; flex-direction:column; gap:2px; min-width:0; }
.name { font-weight: 700; color: var(--text, #e6eefb); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.domain { font-size: 0.85rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* visit icon (appear subtle) */
.visit {
  margin-left: auto;
  color: rgba(255,255,255,0.65);
  display:flex;
  align-items:center;
  justify-content:center;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  transition: transform .16s ease, background .16s ease, color .16s ease;
}
.friend-card:hover .visit { transform: translateY(-2px) scale(1.06); color: var(--primary, #60A5FA); background: rgba(255,255,255,0.02); }

/* description */
.desc{
  color: var(--muted);
  font-size: 0.95rem;
  line-height: 1.35;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
}

/* responsive tweaks */
@media (max-width: 640px) {
  .avatar { --size: 48px; }
  .friend-card { padding: 12px; min-height: 96px; }
}

/* accessibility */
@media (prefers-reduced-motion: reduce) {
  * { transition: none !important; animation: none !important; }
}

/* small polish: keyboard focus */
.friend-card:focus-visible {
  outline: 3px solid rgba(96,165,250,0.14);
  outline-offset: 3px;
}
</style>
